{% extends "base.html" %}

{% block title %}Central Commandes{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8" x-data="{ loading: false }">

    <div class="flex flex-col md:flex-row justify-between items-end mb-12 gap-6">
        <div class="space-y-2">
            <div class="flex items-center gap-3">
                <span class="h-[2px] w-12 bg-yellow-500"></span>
                <span class="text-yellow-500 font-black uppercase tracking-[0.3em] text-[10px]">
                    Mode : {{ user.get_role_display|default:user.role }}
                </span>
            </div>
            <h1 class="text-6xl font-black italic tracking-tighter cmd-title">
                CENTRAL <span class="text-yellow-400">COMMANDES</span>
            </h1>
        </div>

        <div class="flex items-center gap-4">
            <div class="cmd-counter-box px-6 py-4 rounded-3xl border border-white/10 flex items-center gap-4">
                <div class="text-right border-r border-white/10 pr-4">
                    <p class="text-[9px] text-gray-500 uppercase font-black">Volume total</p>
                    <p class="text-2xl font-black italic cmd-count">{{ commandes|length }}</p>
                </div>
                <div class="pl-2">
                    <div class="h-3 w-3 bg-green-500 rounded-full animate-ping"></div>
                </div>
            </div>

            {% if user.role == 'admin' or user.is_superuser %}
            <button onclick="askConfirmAction('form-tout-supprimer', 'supprimer TOUTES les commandes', 'Cette action est irr√©versible !')"
                    class="flex items-center gap-2 bg-red-600/20 hover:bg-red-600 text-red-400 hover:text-white px-5 py-4 rounded-2xl border border-red-500/30 font-black text-xs uppercase tracking-widest transition-all">
                üóë Tout supprimer
            </button>
            <form id="form-tout-supprimer" method="POST" action="{% url 'admin_tout_supprimer' %}" class="hidden">
                {% csrf_token %}
                <input type="hidden" name="type" value="commandes">
            </form>
            {% endif %}
        </div>
    </div>

    {# Toasts temporaires #}
    <div id="toast-container" class="fixed top-4 right-4 z-[200] space-y-2 pointer-events-none">
        {% for message in messages %}
        <div class="toast-msg pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-2xl shadow-xl border text-sm font-bold
            {% if message.tags == 'success' %}bg-gray-900/95 text-green-400 border-green-500/30
            {% else %}bg-gray-900/95 text-red-400 border-red-500/30{% endif %}
            backdrop-blur-md animate-slide-in">
            <span>{{ message }}</span>
            <button onclick="this.parentElement.remove()" class="text-white/30 hover:text-white ml-2 text-lg">√ó</button>
        </div>
        {% endfor %}
    </div>

    <div class="cmd-table-wrap backdrop-blur-2xl rounded-[2.5rem] shadow-3xl border border-white/5 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-separate border-spacing-y-2 px-4">
                <thead>
                    <tr class="text-[10px] font-black text-gray-500 uppercase tracking-[0.2em]">
                        <th class="px-6 py-4">R√©f√©rence</th>
                        <th class="px-6 py-4">Table</th>
                        <th class="px-6 py-4">Composition</th>
                        <th class="px-6 py-4 text-right">Montant</th>
                        <th class="px-6 py-4">Statut</th>
                        <th class="px-6 py-4 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for commande in commandes %}
                    <tr class="cmd-row group transition-all duration-300 rounded-2xl">

                        <td class="px-6 py-5 first:rounded-l-2xl">
                            <span class="font-mono text-yellow-500 font-black text-lg">#{{ commande.id }}</span>
                            <p class="text-[10px] text-gray-500 font-bold uppercase">{{ commande.date|date:"H:i" }}</p>
                        </td>

                        <td class="px-6 py-5">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl bg-yellow-500/10 border border-yellow-500/20 flex items-center justify-center">
                                    <span class="text-yellow-500 font-black italic">{{ commande.tablette.table.numero_table }}</span>
                                </div>
                                <span class="cmd-text font-bold text-sm">Table {{ commande.tablette.table.numero_table }}</span>
                            </div>
                        </td>

                        <td class="px-6 py-5">
                            <div class="flex flex-wrap gap-1 max-w-[200px]">
                                {% for item in commande.items.all|slice:":2" %}
                                <span class="text-[10px] cmd-badge px-2 py-1 rounded-md text-gray-400">
                                    {{ item.quantite }}x {{ item.plat.nom|truncatechars:10 }}
                                </span>
                                {% endfor %}
                                {% if commande.items.count > 2 %}
                                <span class="text-[9px] text-gray-600 font-black self-center">+{{ commande.items.count|add:"-2" }}</span>
                                {% endif %}
                            </div>
                        </td>

                        <td class="px-6 py-5 text-right font-mono">
                            <span class="text-xl font-black cmd-text">{{ commande.total|floatformat:0 }}</span>
                            <small class="text-[9px] text-yellow-600 font-black">FG</small>
                        </td>

                        <td class="px-6 py-5">
                            {% if commande.statut == 'en_attente' %}
                            <span class="px-3 py-1 bg-yellow-500/10 text-yellow-500 text-[10px] font-black rounded-full border border-yellow-500/20">ATTENTE</span>
                            {% elif commande.statut == 'servie' %}
                            <span class="px-3 py-1 bg-blue-500/10 text-blue-400 text-[10px] font-black rounded-full border border-blue-500/20">SERVIE</span>
                            {% else %}
                            <span class="px-3 py-1 bg-green-500/10 text-green-400 text-[10px] font-black rounded-full border border-green-500/20">PAYEE</span>
                            {% endif %}
                        </td>

                        <td class="px-6 py-5 text-center last:rounded-r-2xl">
                            <div class="flex items-center justify-center gap-2">
                                <button onclick="openDetailsModal('{{ commande.id }}', '{{ commande.tablette.table.numero_table }}', '{{ commande.total }}', '{{ commande.statut }}', '{{ commande.date|date:'d/m/Y H:i' }}', `{% for item in commande.items.all %}<div class='flex justify-between py-2 border-b border-white/5'><span>{{ item.plat.nom }}</span><span class='font-black text-yellow-500'>x{{ item.quantite }}</span></div>{% endfor %}`)"
                                        class="p-2 hover:bg-yellow-500 hover:text-black rounded-lg transition-all border border-white/5 bg-white/5 text-white">
                                    üëÅ
                                </button>

                                {% if user.role == 'serveur' %}
                                    {% if commande.statut == 'en_attente' %}
                                    <button onclick="askConfirmAction('form-srv-{{ commande.id }}', 'marquer la commande #{{ commande.id }} comme servie', '')"
                                            class="p-2 bg-blue-500/20 text-blue-400 hover:bg-blue-500 hover:text-white rounded-lg border border-blue-500/30">üçΩÔ∏è</button>
                                    <form id="form-srv-{{ commande.id }}" method="POST" action="{% url 'serveur_valider_commande' commande.id %}" class="hidden">{% csrf_token %}</form>
                                    {% elif commande.statut == 'servie' %}
                                    <button onclick="askConfirmAction('form-pay-{{ commande.id }}', 'encaisser {{ commande.total }} FG pour la commande #{{ commande.id }}', '')"
                                            class="p-2 bg-green-500/20 text-green-400 hover:bg-green-500 hover:text-white rounded-lg border border-green-500/30">üí∞</button>
                                    <form id="form-pay-{{ commande.id }}" method="POST" action="{% url 'serveur_valider_paiement' commande.id %}" class="hidden">{% csrf_token %}</form>
                                    {% endif %}
                                {% endif %}

                                {% if user.role == 'admin' or user.is_superuser %}
                                <button onclick="askConfirmAction('form-del-cmd-{{ commande.id }}', 'supprimer d√©finitivement la commande #{{ commande.id }}', '')"
                                        class="p-2 bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white rounded-lg border border-red-500/20">üóë</button>
                                <form id="form-del-cmd-{{ commande.id }}" method="POST" action="{% url 'supprimer_commande' commande.id %}" class="hidden">{% csrf_token %}</form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="px-6 py-20 text-center text-gray-600 italic">Aucune commande enregistr√©e.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{# Modal d√©tails #}
<div id="detailsModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center z-[100] p-4">
    <div class="details-modal-box border border-white/10 rounded-[2.5rem] shadow-2xl w-full max-w-md overflow-hidden">
        <div class="px-8 py-6 border-b border-white/5 flex justify-between items-center">
            <h2 class="text-xl font-black italic cmd-text">RECAPITULATIF <span class="text-yellow-400">#</span><span id="d_id" class="text-yellow-400"></span></h2>
            <button onclick="closeDetailsModal()" class="text-gray-500 hover:text-white text-2xl">&times;</button>
        </div>
        <div class="p-8 space-y-6">
            <div id="d_plats"></div>
            <button onclick="closeDetailsModal()" class="w-full bg-white text-black py-4 rounded-2xl font-black uppercase hover:bg-yellow-500 transition-all">
                Fermer
            </button>
        </div>
    </div>
</div>

{# Modal Confirmation Action (remplace confirm()) #}
<div id="modalConfirmAction" class="hidden fixed inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center z-[150] p-4">
    <div class="bg-gray-800 border border-gray-700 p-7 rounded-2xl w-full max-w-sm text-center shadow-2xl">
        <div class="text-yellow-500 text-5xl mb-3">‚ùì</div>
        <h3 class="text-xl font-bold text-white mb-2">Confirmation</h3>
        <p class="text-gray-400 mb-1 text-sm">Voulez-vous vraiment</p>
        <p id="confirmActionLabel" class="text-white font-bold italic text-sm mb-2"></p>
        <p id="confirmActionSubLabel" class="text-red-400 text-xs mb-6"></p>
        <div class="flex gap-3">
            <button onclick="closeConfirmAction()" class="flex-1 px-4 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-xl transition font-bold">Annuler</button>
            <button id="btnConfirmAction" class="flex-1 px-4 py-3 bg-yellow-500 hover:bg-yellow-400 text-black rounded-xl font-black transition">Confirmer</button>
        </div>
    </div>
</div>

<style>
  @keyframes slide-in {
    from { opacity: 0; transform: translateX(100%); }
    to { opacity: 1; transform: translateX(0); }
  }
  .animate-slide-in { animation: slide-in 0.3s ease-out; }

  /* DARK */
  .cmd-title { color: #ffffff; }
  .cmd-text { color: #ffffff; }
  .cmd-count { color: #ffffff; }
  .cmd-counter-box { background: rgba(255,255,255,0.05); backdrop-filter: blur(24px); }
  .cmd-row { background: rgba(255,255,255,0.02); }
  .cmd-row:hover { background: rgba(255,255,255,0.05); }
  .cmd-badge { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05); }
  .cmd-table-wrap { background: rgba(17,24,39,0.4); }
  .details-modal-box { background: #111827; }

  /* LIGHT */
  body.light-mode .cmd-title { color: #111827 !important; }
  body.light-mode .cmd-text { color: #111827 !important; }
  body.light-mode .cmd-count { color: #111827 !important; }
  body.light-mode .cmd-counter-box { background: #ffffff !important; border-color: #e5e7eb !important; box-shadow: 0 2px 10px rgba(0,0,0,0.08) !important; }
  body.light-mode .cmd-row { background: #ffffff !important; box-shadow: 0 1px 6px rgba(0,0,0,0.05); }
  body.light-mode .cmd-row:hover { background: #f9fafb !important; }
  body.light-mode .cmd-badge { background: #f3f4f6 !important; border-color: #e5e7eb !important; color: #374151 !important; }
  body.light-mode .cmd-table-wrap { background: #f3f4f6 !important; border-color: #e5e7eb !important; }
  body.light-mode .details-modal-box { background: #ffffff !important; border-color: #e5e7eb !important; }
</style>

<script>
let actionFormId = null;

function openDetailsModal(id, table, total, statut, date, plats) {
    document.getElementById('d_id').innerText = id;
    document.getElementById('d_plats').innerHTML = plats;
    document.getElementById('detailsModal').classList.remove('hidden');
}
function closeDetailsModal() {
    document.getElementById('detailsModal').classList.add('hidden');
}

function askConfirmAction(formId, label, subLabel) {
    actionFormId = formId;
    document.getElementById('confirmActionLabel').textContent = label + ' ?';
    document.getElementById('confirmActionSubLabel').textContent = subLabel;
    document.getElementById('modalConfirmAction').classList.remove('hidden');
}
function closeConfirmAction() {
    document.getElementById('modalConfirmAction').classList.add('hidden');
    actionFormId = null;
}
document.getElementById('btnConfirmAction').addEventListener('click', function() {
    if (actionFormId) {
        document.getElementById(actionFormId).submit();
    }
});

// Fermer en cliquant √† l'ext√©rieur
document.getElementById('detailsModal').addEventListener('click', function(e) {
    if (e.target === this) closeDetailsModal();
});
document.getElementById('modalConfirmAction').addEventListener('click', function(e) {
    if (e.target === this) closeConfirmAction();
});

// Auto-dismiss toasts
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.toast-msg').forEach(function(el) {
        setTimeout(function() {
            el.style.transition = 'all 0.4s ease';
            el.style.opacity = '0';
            el.style.transform = 'translateX(100%)';
            setTimeout(function() { el.remove(); }, 400);
        }, 5000);
    });
});
</script>
{% endblock %}

